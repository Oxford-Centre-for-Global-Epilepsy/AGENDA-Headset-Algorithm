# ========================================================================
# üèÜ Data File Preparation Workflow Entry
#
#   Workflow Purpose: Convert raw data files to common file format (.edf)
# ========================================================================
include: "rules/data_preprocessing/convert_data_to_edf.smk"
#include: "rules/move_edf_files.smk"

import os

configfile: "config/config.yaml"

# üî• Get $DATA environment variable (ensure it's set)
DATA_PATH = os.getenv("DATA")
if not DATA_PATH:
    raise ValueError("ERROR: The $DATA environment variable is not set!")

data_raw = f"{DATA_PATH}/AGENDA-Headset-Algorithm/data/raw"
data_edf = f"{DATA_PATH}/AGENDA-Headset-Algorithm/data/edf"

# =======================
# üîé Discover Files
# =======================

def discover_eeg_files(file_extension=".EEG"):
    """Find all .EEG files in raw data directory"""
    eeg_files = []
    for root, _, files in os.walk(data_raw):
        for file in files:
            if file.endswith(file_extension):
                relative_path = os.path.relpath(os.path.join(root, file), data_raw)
                eeg_files.append(relative_path.replace(file_extension, ""))
    return eeg_files

# Define the file paths
NK_EEG_FILEPATHS = discover_eeg_files(file_extension=".EEG")
EXISTING_EDF_FILEPATHS = discover_eeg_files(file_extension=".edf")

# üèÜ **Final list includes both converted & pre-existing .edf files**
EDF_FILEPATHS = NK_EEG_FILEPATHS + EXISTING_EDF_FILEPATHS

print(f"‚úÖ Nihon Kohden EEG files found: {NK_EEG_FILEPATHS}")
print(f"‚úÖ Existing .EDF files found: {EXISTING_EDF_FILEPATHS}")
print(f"‚úÖ All .EDF files for processing: {EDF_FILEPATHS}")

# =======================
# üèÅ Define rule all
# =======================
rule all:
    input:
        expand(data_raw + "/{sample}.edf", sample=EDF_FILEPATHS)
        #expand(data_edf + "/{sample}.edf", sample=EDF_FILEPATHS)